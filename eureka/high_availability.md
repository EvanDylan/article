# 高可用之术

本篇尽可能的将Eureka中高可用的解决应对之道表述清晰。如果大家能够从中有些许的收获，那么本篇的目的也就达到了。如果有不足和错误之处，烦请大家批评指正。

## 概念

在提到高可用的时候，我们到底在讨论个什么东西？它又是怎么定义的“高可用”这个概念？（引用来自wiki百科的定义）

> **高可用性**（英语：high availability，缩写为 HA），[IT](https://zh.wikipedia.org/wiki/IT)术语，指系统无中断地执行其功能的能力，代表系统的[可用性](https://zh.wikipedia.org/wiki/%E5%8F%AF%E7%94%A8%E6%80%A7)程度。是进行系统设计时的准则之一。高可用性系统与构成该系统的各个组件相比可以更长时间运行。高可用性通常通过提高系统的容错能力来实现。定义一个系统怎样才算具有高可用性往往需要根据每一个案例的具体情况来具体分析。
>
> 其度量方式，是根据系统损害、无法使用的时间，以及由无法运作恢复到可运作状况的时间，与系统总运作时间的比较。计算公式为:![](https://wikimedia.org/api/rest_v1/media/math/render/svg/294530834e910381725a2dd83c38873aac055da5)
>
> A（可用性），MTBF(平均故障间隔)，MDT(平均修复时间)
>
> 在线系统和执行关键任务的系统通常要求其可用性要达到5个9标准(99.999%)。
>
> |  可用性  |  年故障时间   |
> | :------: | :-----------: |
> | 99.9999% |     32秒      |
> | 99.999%  |    5分15秒    |
> |  99.99%  |   52分34秒    |
> |  99.9%   |   8小时46分   |
> |   99%    | 3天15小时36分 |

## 应对之道

在上面的定义中“高可用性通常通过提高系统的容错能力来实现”这句话概述了高可用实现的指导性原则。那么在Eureka中它是如何应对各种异常，又是如何容错的呢。我们分以下两种场景展开讨论：

- Eureka客户端异常，突然访问不了服务端
- Eureka Server端异常，接收不到客户端的以及其他节点的请求。

## Eureka客户端异常

如果异常发生在客户端，那么客户端就不能及时的更新远程注册以及上报自己的应用状态，那么造成的影响我们从以下几个维度分析。

- 第一个维度假设客户端仅仅作为服务消费方Consumer。

|                  对客户端应用Consumer的影响                  | 对服务提供方Provider的影响 | 对注册中心的影响 |
| :----------------------------------------------------------: | :------------------------: | :--------------: |
| 由于本地缓存的存在，可以通过缓存中维护的注册信息，可以正常的继续访问第三方服务。一旦第三方服务下线，会造成部分服务不可用。 |           无影响           |      无影响      |

- 第二个维度假设客户端作为服务提供方Provider。

| 对客户端应用Provider的影响 |                  对服务消费方Consumer的影响                  |                       对注册中心的影响                       |
| :------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
|           无影响           | 由于本地缓存的存在，可以继续通过缓存访问第三方服务。一旦服务下线，则会造成部分服务不可用。 | 由于长时间感知不到提供方心跳，会被主动剔除，增大了其他相同实例的压力。如果只有一个实例，则当前服务完全不可用。 |

## Eureka Server异常

在Eureka Server异常的这种场景下，我们分单台异常和全部异常这两种场景展开分析。

- 单台Eureka Server异常

|                  对客户端应用Consumer的影响                  | 对客户端应用Provider的影响 | 对其他节点的影响 |
| :----------------------------------------------------------: | :------------------------: | :--------------: |
| 几乎很小，通过failover机制，尝试连接其他的Eureka Server节点拉去注册信息。 |    没有影响，注册信息会    |      无影响      |

- Eureka Server全部都异常

|                  对客户端应用Consumer的影响                  |  对客户端应用Provider的影响  | 整个注册服务影响 |
| :----------------------------------------------------------: | :--------------------------: | :--------------: |
| 通过客户端内的缓存注册信息，调用第三方服务不受影响。但是收不到最新的注册信息了，一旦部分应用下线，由于failover机制存在会导致应用调用时间变长，吞吐量下降。 | 应用上下线操作都不可以进行。 |      不可用      |

通过上面的各种异常场景的分析，我们可以总结出Eureka对容错的一些解决套路

- 客户端缓存注册信息，降低服务端异常的影响。
- 通过failover机制，降低由于第三方某个实例异常的影响。
- 互备机制则保证Eureka服务端可用性。
